<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 
<mapper namespace="com.happyhouse.api.deal.dao.DealDao">
	
	<select id = "cityList" parameterType="int" resultType="com.happyhouse.api.deal.dto.CityDto">
		select code, name
		<choose>
			 <when test="code lt 10">
			 	from sido
			 </when>
			 <when test="code lt 100">
			 	from gugun
			 	where sido_code = #{code}
			 </when>
			 <otherwise>
			 	from dong
			 	where gugun_code = #{code}
			 </otherwise>
		 </choose>
	</select>
	
	<insert id="dealInsert" parameterType="com.happyhouse.api.deal.dto.DealParamDto" useGeneratedKeys="true" keyProperty="dealId">
		insert into deal (house_id,deal_price,deal_date,deal_floor,deal_area,code,deal_complete)
			values (#{houseId},#{dealPrice},now(),0,0,0,0)
	</insert>
	
	<insert id="houseInsert" parameterType="com.happyhouse.api.deal.dto.DealParamDto" useGeneratedKeys="true" keyProperty="houseId">
		insert into house (house_name, house_build_year,house_dong_code , house_dong_name , house_jibun, house_lat, house_lng, house_gugun_code,house_gugun_name)
			values (#{houseName},#{houseBuildYear},#{houseDongCode},#{houseDongName},#{houseJibun},#{houseLat},#{houseLng},#{houseGugunCode},#{houseGugunName})
	</insert>
	
	<insert id="fileInsert" parameterType="com.happyhouse.api.deal.dto.FileDto">
		insert into deal_file (deal_id,file_name,file_size,file_content_type,file_url,file_reg_dt)
			values(#{dealId},#{fileName},#{fileSize},#{fileContentType},#{fileUrl},now())
	</insert>
	
	<select id = "houseList" parameterType="string" resultType="com.happyhouse.api.deal.dto.HouseDto">
		select * 
		 from house
		 <if test = '!searchWord.equals("-")'>
			where house_dong_name like concat('%',#{keyword},'%')
			 or house_name like concat('%',#{keyword},'%')
		 </if>
	</select>
	
	
	<select id="dealList" parameterType="com.happyhouse.api.deal.dto.DealParamDto" resultType="com.happyhouse.api.deal.dto.DealParamDto">
		select a.*, b.file_url 
		 from(
			select d.deal_id, d.house_id,d.deal_price,d.deal_floor,d.deal_area,d.code,d.deal_complete,d.deal_content,
			h.house_name,h.house_sido_name,h.house_gugun_name,h.house_dong_name,h.house_jibun
			from deal d join house h 
			on d.house_id = h.house_id
			) a left join (select * 
					from(
					SELECT ROW_NUMBER() OVER(PARTITION BY deal_file.deal_id) AS RNUM, deal_file.deal_id , deal_file.file_url
					FROM deal_file
				) r
				where rnum = 1) b
		on a.deal_id = b.deal_id 
		<if test = '!searchType.equals("0")'>
			where code = #{searchType} 
		</if>
		<if test = '!searchWord.equals("")'>
			<if test = '!searchType.equals("0")'>
				and 
			</if>
			<if test = 'searchType.equals("0")'>
				where 
			</if>
			a.house_name like concat('%' , #{searchWord} , '%')
		</if>
		
		limit #{limit} offset #{offset}
	</select>
	
	<select id="dealListCount" parameterType="com.happyhouse.api.deal.dto.DealParamDto" resultType="int">
		select count(*) 
		 from(
			select d.deal_id , d.house_id, d.code,h.house_name
			from deal d join house h 
			on d.house_id = h.house_id
			) a 
		<if test = '!searchType.equals("0")'>
			where code = #{searchType} 
		</if>
		<if test = '!searchWord.equals("")'>
			<if test = '!searchType.equals("0")'>
				and 
			</if>
			<if test = 'searchType.equals("0")'>
				where 
			</if>
			a.house_name like concat('%' , #{searchWord} , '%')
		</if>
		
	</select>
	
	
</mapper>
