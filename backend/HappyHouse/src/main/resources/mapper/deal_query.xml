<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 
<mapper namespace="com.happyhouse.api.deal.dao.DealDao">
	
	<insert id="houseInsert" parameterType="com.happyhouse.api.deal.dto.HouseDto" useGeneratedKeys="true" keyProperty="houseId">
		insert into house (house_name, house_build_year, 
							house_sido_code, house_sido_name,
							house_gugun_code,house_gugun_name, 
							house_dong_code , house_dong_name , 
							house_jibun, house_lat, house_lng,
							code )
				   values (#{houseName},#{houseBuildYear},
				   			#{houseSidoCode}, #{houseSidoName},
				   			#{houseGugunCode},#{houseGugunName},
				   			#{houseDongCode},#{houseDongName},			   			
				   			#{houseJibun},#{houseLat},#{houseLng},
				   			#{code} )
	</insert>	
	
	<insert id="dealInsert" parameterType="com.happyhouse.api.deal.dto.DealDto" useGeneratedKeys="true" keyProperty="dealId">
		insert into deal (house_id, deal_price, deal_deposit, deal_floor, deal_area,
							code, deal_content, user_id)
				  values (#{houseId},#{dealPrice}, #{dealDeposit}, #{dealFloor}, #{dealArea},
				  			#{code}, #{dealContent}, #{userId})
	</insert>
	
	<insert id="fileInsert" parameterType="com.happyhouse.api.deal.dto.FileDto">
		insert into deal_file (deal_id, file_name, file_size, file_content_type, file_url, file_reg_dt)
						values(#{dealId}, #{fileName}, #{fileSize}, #{fileContentType}, #{fileUrl}, now())
	</insert>
	
	<select id = "houseList" parameterType="string" resultType="com.happyhouse.api.deal.dto.HouseDto">
		select * 
		 from house
		 <if test = '!searchWord.equals("-")'>
			where house_dong_name like concat('%',#{keyword},'%')
			 or house_name like concat('%',#{keyword},'%')
		 </if>
	</select>
		
	<select id="dealList" parameterType="com.happyhouse.api.deal.dto.DealParamDto" resultType="com.happyhouse.api.deal.dto.DealParamDto">
		select a.*, b.file_url 
		 from(
			select d.deal_id, d.house_id,d.deal_price,d.deal_floor,d.deal_area,d.code,d.deal_complete,d.deal_content,
			h.house_name,h.house_sido_name,h.house_gugun_name,h.house_dong_name,h.house_jibun
			from deal d join house h 
			on d.house_id = h.house_id
			) a left join (select * 
					from(
					SELECT ROW_NUMBER() OVER(PARTITION BY deal_file.deal_id) AS RNUM, deal_file.deal_id , deal_file.file_url
					FROM deal_file
				) r
				where rnum = 1) b
		on a.deal_id = b.deal_id 
		<if test = '!searchType.equals("0")'>
			where code = #{searchType} 
		</if>
		<if test = '!searchWord.equals("")'>
			<if test = '!searchType.equals("0")'>
				and 
			</if>
			<if test = 'searchType.equals("0")'>
				where 
			</if>
			a.house_name like concat('%' , #{searchWord} , '%')
		</if>
		
		limit #{limit} offset #{offset}
	</select>
	
	<select id="dealListCount" parameterType="com.happyhouse.api.deal.dto.DealParamDto" resultType="int">
		select count(*) 
		 from(
			select d.deal_id , d.house_id, d.code,h.house_name
			from deal d join house h 
			on d.house_id = h.house_id
			) a 
		<if test = '!searchType.equals("0")'>
			where code = #{searchType} 
		</if>
		<if test = '!searchWord.equals("")'>
			<if test = '!searchType.equals("0")'>
				and 
			</if>
			<if test = 'searchType.equals("0")'>
				where 
			</if>
			a.house_name like concat('%' , #{searchWord} , '%')
		</if>
		
	</select>
	
	<select id ="imgList" parameterType="int" resultType="string">
		select file_url from deal_file where deal_id = #{dealId}
	</select>
	
	<select id ="dealDetail" parameterType="int" resultType="com.happyhouse.api.deal.dto.DealDto">
		select * from deal where deal_id = #{dealId}
	</select>
	
	<select id ="houseDetail" parameterType="int" resultType="com.happyhouse.api.deal.dto.HouseDto">
		select * from house where house_id = (select house_id from deal where deal_id = #{dealId})
	</select>
	
	<select id="searchByAddress" parameterType="string" resultType="com.happyhouse.api.deal.dto.HouseDto">
		select house_id, house_name, house_build_year,
				house_sido_code, house_sido_name,
				house_gugun_code, house_gugun_name,
				house_dong_code, house_dong_name,
				house_jibun,code, house_lat, house_lng
		   from house
		  where house_dong_code = #{dongCode}
	</select>
	
	<select id="searchByKeyword" parameterType="string" resultType="com.happyhouse.api.deal.dto.HouseDto">
		select house_id, house_name, house_build_year,
				house_sido_code, house_sido_name,
				house_gugun_code, house_gugun_name,
				house_dong_code, house_dong_name,
				house_jibun, code, house_lat, house_lng
		   from house
		  where house_name like concat("%", #{keyword}, "%")	
	</select>
	
	<select id="getOldDealList" parameterType="int" resultType="com.happyhouse.api.deal.dto.DealDto">
		select deal_id, house_id, deal_price, deal_deposit, deal_date, deal_floor, deal_area, code
		  from deal
		 where house_id = #{houseId}
		   and deal_complete = 1;
	</select>
	
	<select id="getNowDealList" parameterType="int" resultType="com.happyhouse.api.deal.dto.DealDto">
		select deal_id, house_id, deal_price, deal_deposit, deal_date, deal_floor, deal_area, code
		  from deal
		 where house_id = #{houseId}
		   and deal_complete = 0;
	</select>
	
	<select id="getReviewList" parameterType="int" resultType="com.happyhouse.api.review.dto.ReviewResultDto">
		select r.review_id, u.user_id, u.user_name, u.user_reg_dt, r.review_content,
			   r.review_trafic_rating, r.review_safety_rating, r.review_store_rating
		  from review r, users u
		 where u.user_id = r.user_id
		   and house_id = #{houseId};
	</select>
	
</mapper>
